<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>绿茵球衣馆</title>
  <style>
    :root{--paper:#f7f2e8;--ink:#1f1f1a;--muted:#6b665d;--line:#b8b0a3;--accent:#7b1f1f;--card:#fbf8f0}
    *{box-sizing:border-box} body{margin:0;color:var(--ink);background:radial-gradient(ellipse at top,#fffdf7 0%,var(--paper) 60%);font-family:"Times New Roman","Songti SC",serif}
    .page{max-width:1200px;margin:24px auto;padding:14px 18px 30px;background:var(--paper);border:1px solid var(--line)}
    .masthead{border-top:3px double var(--ink);border-bottom:3px double var(--ink);text-align:center;padding:14px 0 10px;margin-bottom:14px}
    .kicker,.meta,.label,.tag{font-size:12px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)} .title{font-size:clamp(34px,7vw,66px);margin:6px 0 0}
    .lead{display:grid;grid-template-columns:2fr 1fr;gap:14px;border-bottom:1px solid var(--line);padding-bottom:12px;margin-bottom:12px}
    .lead h2{margin:0 0 8px;font-size:clamp(22px,4vw,38px)} .quote{border-left:3px solid var(--ink);padding-left:10px;font-style:italic;align-self:center}
    .stats{display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:10px;margin:10px 0 14px}.stat{border:1px solid var(--line);background:#fffdf9;padding:8px 10px}.value{font-size:24px;font-weight:700;color:var(--accent)}
    .toolbar{display:grid;grid-template-columns:1.1fr .8fr .8fr .7fr .7fr .8fr .8fr auto;gap:8px;align-items:center;border-bottom:1px dashed var(--line);padding-bottom:10px;margin-bottom:14px}
    input,select,button{width:100%;font:inherit;border:1px solid var(--line);background:#fffdf9;padding:8px 10px}button{cursor:pointer}.sync{background:#243d63;color:#fff}
    .switch{display:inline-flex;gap:6px}.switch button{min-width:86px;background:#f2ecdf}.switch .active{background:#e7dbc5}
    .catalog{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .card{padding:12px;background:var(--card);border:1px solid var(--line);position:relative;min-height:250px}.card::before{content:"";position:absolute;left:0;right:0;top:0;height:3px;background:repeating-linear-gradient(90deg,var(--ink)0 14px,transparent 14px 20px);opacity:.12}
    .kitimg{width:100%;aspect-ratio:4/5;object-fit:cover;border:1px solid var(--line);margin:6px 0 8px;background:#eee}
    .imgcap{font-size:12px;color:var(--muted);margin:-2px 0 8px}
    .card h3{margin:0 0 2px;font-size:22px}.subtitle,.meta2,.desc,.src{font-size:14px;margin:0 0 6px}.number{margin-top:8px;font-size:26px;font-weight:700;color:var(--accent)}
    .actions{display:flex;gap:8px;margin-top:8px}.owned{background:#1e4c2f;color:#fff}
    .risk{display:inline-block;padding:2px 6px;border:1px solid var(--line);font-size:12px}.low{background:#e6f4ea}.mid{background:#fff4dd}.high{background:#fde8e8}
    @media (max-width:980px){.lead{grid-template-columns:1fr}.stats{grid-template-columns:repeat(2,minmax(120px,1fr))}.toolbar{grid-template-columns:1fr 1fr}.toolbar input{grid-column:1/-1}.catalog{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:620px){.page{margin:0;border:0}.catalog{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="page">
    <header class="masthead">
      <div class="kicker">football archive weekly</div>
      <h1 class="title">绿茵球衣馆</h1>
      <div class="meta">按俱乐部 / 国家队浏览</div>
    </header>

    <section class="lead">
      <article>
        <h2>从“人名导向”改成“俱乐部 / 国家队”主分类</h2>
        <p>先看队，再看人。你可以先选俱乐部或国家队，再在该分类里按年代与球员筛选。</p>
      </article>
      <aside class="quote">“看球衣，也是在看球队的历史人格。”</aside>
    </section>

    <section class="stats">
      <div class="stat"><div class="label">数据库总条目</div><div id="s-total" class="value">0</div></div>
      <div class="stat"><div class="label">已拥有</div><div id="s-owned" class="value">0</div></div>
      <div class="stat"><div class="label">俱乐部</div><div id="s-club" class="value">0</div></div>
      <div class="stat"><div class="label">国家队</div><div id="s-country" class="value">0</div></div>
      <div class="stat"><div class="label">最近同步</div><div id="s-sync" class="value" style="font-size:14px">—</div></div>
    </section>

    <section class="toolbar">
      <input id="search" placeholder="搜索球员/球队/设计背景" />
      <select id="category"><option value="all">全部分类</option><option value="club">俱乐部</option><option value="country">国家队</option></select>
      <select id="entity"><option value="all">全部队伍</option></select>
      <select id="year"><option value="all">全部年份</option></select>
      <select id="type"><option value="all">主客场</option><option value="Home">主场</option><option value="Away">客场</option></select>
      <select id="era"><option value="all">全部年代</option><option value="90s">1990s</option><option value="00s">2000s</option><option value="10s">2010s</option><option value="20s">2020s</option></select>
      <select id="sort"><option value="year-desc">年份新→旧</option><option value="year-asc">年份旧→新</option><option value="name">球员A→Z</option><option value="cred">可信度高→低</option></select>
      <button id="sync" class="sync">更新馆藏</button>
      <div class="switch"><button id="allTab" class="active">全部</button><button id="ownTab">只看已拥有</button></div>
    </section>

    <section id="catalog" class="catalog"></section>
  </main>

<script>
const KEY_OWN='jerseyMuseumOwnedV1',KEY_DB='jerseyMuseumDBV3',KEY_SYNC='jerseyMuseumLastSyncV3';
const $=id=>document.getElementById(id);
const state={mode:'all',items:[],owned:new Set(JSON.parse(localStorage.getItem(KEY_OWN)||'[]'))};

function riskClass(c){return c>=90?['低风险','low']:c>=75?['中风险','mid']:['高风险','high']}
function keyOf(x){return `${x.category}|${x.entity}|${x.player}|${x.year}|${x.type}`.toLowerCase()}
function merge(base,incoming){const m=new Map(base.map(i=>[keyOf(i),i])); for(const it of incoming){const k=keyOf(it),old=m.get(k); if(!old){m.set(k,it);continue;} const od=+new Date(old.last_verified||0),nd=+new Date(it.last_verified||0); if((it.credibility||0)>(old.credibility||0)||nd>od)m.set(k,{...old,...it});} return [...m.values()]}
function save(){localStorage.setItem(KEY_DB,JSON.stringify(state.items));localStorage.setItem(KEY_OWN,JSON.stringify([...state.owned]))}

async function load(){
  const cached=localStorage.getItem(KEY_DB); if(cached){state.items=JSON.parse(cached)}
  try{ const r=await fetch('./jersey-db.json?ts='+Date.now()); if(r.ok){state.items=await r.json(); save();} }catch(e){}
  buildEntityOptions();
  buildYearOptions();
  applyFilters();
}

function buildEntityOptions(){
  const cat=$('category').value;
  const list=[...new Set(state.items.filter(i=>cat==='all'||i.category===cat).map(i=>i.entity))].sort();
  $('entity').innerHTML='<option value="all">全部队伍</option>'+list.map(v=>`<option value="${v}">${v}</option>`).join('');
}

function buildYearOptions(){
  const cat=$('category').value,entity=$('entity').value;
  const years=[...new Set(state.items.filter(i=>(cat==='all'||i.category===cat)&&(entity==='all'||i.entity===entity)).map(i=>i.year))].sort((a,b)=>b-a);
  $('year').innerHTML='<option value="all">全部年份</option>'+years.map(v=>`<option value="${v}">${v}</option>`).join('');
}

function updateStats(){
  $('s-total').textContent=state.items.length;
  $('s-owned').textContent=state.owned.size;
  $('s-club').textContent=new Set(state.items.filter(i=>i.category==='club').map(i=>i.entity)).size;
  $('s-country').textContent=new Set(state.items.filter(i=>i.category==='country').map(i=>i.entity)).size;
  $('s-sync').textContent=localStorage.getItem(KEY_SYNC)||'未同步';
}

function toggleOwned(id){state.owned.has(id)?state.owned.delete(id):state.owned.add(id); save(); applyFilters()} window.toggleOwned=toggleOwned;

function render(items){
  const c=$('catalog');
  if(!items.length){c.innerHTML='<article class="card"><h3>暂无结果</h3><p>换个筛选条件试试。</p></article>';return}
  c.innerHTML=items.map(x=>{const own=state.owned.has(x.id);const [rt,rc]=riskClass(x.credibility||0);
    const typeLabel=x.type==='Home'?'主场':x.type==='Away'?'客场':x.type;
    const img=x.image_official_url||x.image_url||`https://placehold.co/640x800/f2f2f2/1f1f1f.png?text=${encodeURIComponent(x.entity+' '+x.year+' '+typeLabel)}`;
    const capText=x.image_official_url?'图片：来源站点配图':'图片：馆藏图';
    return `<article class="card"><div class="tag">${x.category==='club'?'俱乐部':'国家队'} · ${x.league} · ${x.year}</div><h3>${x.entity}</h3><div class="subtitle">${x.player} · ${x.brand} · ${typeLabel}</div><img class="kitimg" data-id="${x.id}" src="${img}" alt="${x.entity} ${x.year} ${typeLabel}球衣" loading="lazy"/><div class="imgcap" id="cap-${x.id}">${capText}</div><p class="meta2">设计背景：${x.design_background}</p><p class="desc">${x.cultural_notes}</p><p class="src"><span class="risk ${rc}">${rt} / ${x.credibility||'-'}</span></p><div class="number">#${x.number}</div><div class="actions"><button class="${own?'owned':''}" onclick="toggleOwned('${x.id}')">${own?'已拥有 ✓':'标记为已拥有'}</button></div></article>`;
  }).join('');
  hydrateRealImages(items);
}

async function fetchWikimediaImage(query){
  const url='https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=' + encodeURIComponent(query) + '&gsrlimit=1&prop=pageimages|info&pithumbsize=800&inprop=url&format=json&origin=*';
  const res=await fetch(url);
  if(!res.ok) return null;
  const data=await res.json();
  const pages=data?.query?.pages ? Object.values(data.query.pages) : [];
  const p=pages[0];
  return p?.thumbnail?.source || null;
}

async function fetchWikipediaEntityImage(entity){
  const candidates = [entity, `${entity} F.C.`, `${entity} national football team`];
  for (const c of candidates) {
    const title = encodeURIComponent(c.replace(/\s+/g, '_'));
    const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${title}`;
    try {
      const res = await fetch(url);
      if (!res.ok) continue;
      const data = await res.json();
      if (data?.thumbnail?.source) return data.thumbnail.source;
    } catch (e) {}
  }
  return null;
}

async function hydrateRealImages(items){
  const cacheKey='jerseyImageCacheV1';
  const cache=JSON.parse(localStorage.getItem(cacheKey)||'{}');
  for(const it of items){
    const el=document.querySelector(`img.kitimg[data-id="${it.id}"]`);
    if(!el) continue;
    const cap=document.getElementById(`cap-${it.id}`);
    if(it.image_official_url){
      el.src=it.image_official_url;
      if(cap) cap.textContent='图片：来源站点配图';
      continue;
    }
    if(cache[it.id]){ el.src=cache[it.id]; if(cap) cap.textContent='图片：Wikimedia Commons'; continue; }
    try{
      const q=`${it.entity} ${it.year} ${it.type} football kit`;
      let hit=await fetchWikimediaImage(q);
      let label='图片：Wikimedia Commons';
      if(!hit){
        hit=await fetchWikipediaEntityImage(it.entity);
        label='图片：Wikipedia（队徽/队伍图）';
      }
      if(hit){
        cache[it.id]=hit;
        el.src=hit;
        if(cap) cap.textContent=label;
      }
    }catch(e){}
  }
  localStorage.setItem(cacheKey, JSON.stringify(cache));
}

function applyFilters(){
  const q=$('search').value.trim().toLowerCase(),cat=$('category').value,entity=$('entity').value,year=$('year').value,type=$('type').value,era=$('era').value,sort=$('sort').value;
  let items=state.items.filter(x=>{
    const okCat=cat==='all'||x.category===cat;
    const okEntity=entity==='all'||x.entity===entity;
    const okYear=year==='all'||String(x.year)===String(year);
    const okType=type==='all'||x.type===type;
    const okEra=era==='all'||x.era===era;
    const blob=`${x.entity} ${x.player} ${x.design_background} ${x.cultural_notes}`.toLowerCase();
    const okQ=!q||blob.includes(q);
    const okMode=state.mode==='all'||state.owned.has(x.id);
    return okCat&&okEntity&&okYear&&okType&&okEra&&okQ&&okMode;
  });
  if(sort==='year-desc')items.sort((a,b)=>b.year-a.year);
  if(sort==='year-asc')items.sort((a,b)=>a.year-b.year);
  if(sort==='name')items.sort((a,b)=>a.player.localeCompare(b.player));
  if(sort==='cred')items.sort((a,b)=>(b.credibility||0)-(a.credibility||0));
  updateStats(); render(items);
}

async function syncFeed(){
  try{const r=await fetch('./jersey-feed.json?ts='+Date.now()); if(!r.ok) throw new Error('加载失败'); const feed=await r.json(); state.items=merge(state.items,feed); localStorage.setItem(KEY_SYNC,new Date().toLocaleString()); save(); buildEntityOptions(); buildYearOptions(); applyFilters(); alert(`已更新 ${feed.length} 条，自动完成去重合并`)}catch(e){alert('更新失败：'+e.message)}
}

['search','era','sort','entity','year','type'].forEach(id=>$(id).addEventListener('input',applyFilters));
$('category').addEventListener('change',()=>{buildEntityOptions(); buildYearOptions(); applyFilters()});
$('entity').addEventListener('change',()=>{buildYearOptions(); applyFilters()});
$('sync').addEventListener('click',syncFeed);
$('allTab').addEventListener('click',()=>{state.mode='all';$('allTab').classList.add('active');$('ownTab').classList.remove('active');applyFilters()});
$('ownTab').addEventListener('click',()=>{state.mode='owned';$('ownTab').classList.add('active');$('allTab').classList.remove('active');applyFilters()});
load();
</script>
</body>
</html>